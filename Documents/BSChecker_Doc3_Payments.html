<p><strong>ğŸ” Nah That's Fake</strong></p><p>Payment + Premium Logic</p><p>Document 3 of 13</p><p>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</p><p><strong>Document: </strong>Document 3 of 13 â€” Payment + Premium Logic</p><p><strong>Version: </strong>v1.0 â€” MVP</p><p><strong>Date: </strong>February 2026</p><p><strong>Status: </strong>Draft â€” For Vibe Coding Reference</p><p><strong>Depends On: </strong>Documents 1 &amp; 2 (PRD, Design Flows)</p><table><tr><td><p><strong>ğŸ’³ What This Document Covers</strong></p><p>The complete technical and business specification for all payment flows in Nah That's Fake.</p><p>Covers: Razorpay integration (UPI, cards, netbanking), Telegram Stars integration,</p><p>webhook verification, subscription lifecycle, failed payment recovery, refund policy,</p><p>premium tier activation/deactivation logic, and revenue reconciliation.</p></td></tr></table><h1><strong>1. Pricing &amp; Plans â€” Technical Recap</strong></h1><p>This section formalises the pricing decisions from Document 1 into exact values your code must use. Do not hardcode prices in the UI â€” always read from a config or database so prices can change without redeployment.</p><h2><strong>1.1 Plan Definitions (Source of Truth)</strong></h2><table><thead><tr><th><p><strong>Plan ID</strong></p></th><th><p><strong>Display Name</strong></p></th><th><p><strong>Price (INR)</strong></p></th><th><p><strong>Price (Stars)</strong></p></th><th><p><strong>Billing</strong></p></th><th><p><strong>Checks</strong></p></th></tr></thead><tbody><tr><td><p>free</p></td><td><p>Free</p></td><td><p>0</p></td><td><p>N/A</p></td><td><p>N/A</p></td><td><p>3/day + credits</p></td></tr><tr><td><p>ind_monthly</p></td><td><p>Premium Individual</p></td><td><p>99</p></td><td><p>250</p></td><td><p>Monthly</p></td><td><p>Unlimited</p></td></tr><tr><td><p>ind_annual</p></td><td><p>Premium Individual</p></td><td><p>799</p></td><td><p>1999</p></td><td><p>Annual</p></td><td><p>Unlimited</p></td></tr><tr><td><p>grp_monthly</p></td><td><p>Premium Group</p></td><td><p>299</p></td><td><p>750</p></td><td><p>Monthly</p></td><td><p>Unlimited (group)</p></td></tr></tbody></table><table><tr><td><p><strong>âš ï¸ Stars Price Note</strong></p><p>Telegram Stars pricing above is approximate. The exact Stars equivalent must be set via the</p><p>Telegram Bot API's createInvoiceLink with currency='XTR' (Stars). 1 Star â‰ˆ â‚¹0.40 at time of writing.</p><p>Always verify current exchange before setting Stars prices. Stars prices are set in whole numbers only.</p></td></tr></table><h2><strong>1.2 What Premium Unlocks â€” Exact Feature Flags</strong></h2><p>These are the feature flags your backend must check to gate features. Store them in the users table in Supabase.</p><table><thead><tr><th><p><strong>Feature Flag</strong></p></th><th><p><strong>Free Value</strong></p></th><th><p><strong>Individual Premium</strong></p></th><th><p><strong>Group Premium</strong></p></th></tr></thead><tbody><tr><td><p>daily_check_limit</p></td><td><p>3</p></td><td><p>unlimited</p></td><td><p>unlimited</p></td></tr><tr><td><p>can_export_pdf</p></td><td><p>false</p></td><td><p>true</p></td><td><p>true</p></td></tr><tr><td><p>history_limit</p></td><td><p>10</p></td><td><p>500</p></td><td><p>1000</p></td></tr><tr><td><p>priority_processing</p></td><td><p>false</p></td><td><p>true</p></td><td><p>true</p></td></tr><tr><td><p>group_autoscan</p></td><td><p>false</p></td><td><p>false</p></td><td><p>true</p></td></tr><tr><td><p>group_dashboard</p></td><td><p>false</p></td><td><p>false</p></td><td><p>true</p></td></tr><tr><td><p>autoscan_threshold</p></td><td><p>N/A</p></td><td><p>N/A</p></td><td><p>85 (configurable 70-99)</p></td></tr></tbody></table><h1><strong>2. Razorpay Integration</strong></h1><p>Razorpay is the primary payment processor. It handles UPI, debit cards, credit cards, netbanking, and international cards. Below is the full technical integration spec.</p><h2><strong>2.1 Setup Checklist</strong></h2><ol><li>Create Razorpay account at razorpay.com â€” use a business email.</li><li>Complete KYC â€” you will need PAN + bank account details. Required to receive payouts.</li><li>In the Razorpay dashboard: Settings â†’ API Keys â†’ Generate Key. You need Key ID and Key Secret.</li><li>Store both keys as environment variables â€” NEVER hardcode in source code.</li><li>Add webhook endpoint in Razorpay dashboard: Settings â†’ Webhooks â†’ Add New Webhook.</li><li>Webhook URL: https://yourdomain.com/webhooks/razorpay</li><li>Enable these webhook events: payment.captured, payment.failed, subscription.activated, subscription.charged, subscription.halted, subscription.cancelled, refund.created.</li><li>Note the Webhook Secret from the dashboard â€” store as RAZORPAY_WEBHOOK_SECRET in env vars.</li></ol><h2><strong>2.2 Environment Variables Required</strong></h2><table><tr><td><p># Razorpay</p><p>RAZORPAY_KEY_ID=rzp_live_xxxxxxxxxxxx</p><p>RAZORPAY_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx</p><p>RAZORPAY_WEBHOOK_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx</p><p># Use test keys during development:</p><p>RAZORPAY_KEY_ID=rzp_test_xxxxxxxxxxxx</p><p>RAZORPAY_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx</p></td></tr></table><h2><strong>2.3 Payment Flow â€” One-Time Payment (Manual Renewal)</strong></h2><p>For MVP simplicity, we start with one-time payments. User pays for 30 days or 365 days. No auto-renewal complexity. Subscriptions can be added in v2.</p><table><tr><td><p><strong>1</strong></p></td><td><p><strong>User selects plan in TMA</strong></p><p>TMA calls backend: POST /api/create-order with {plan_id, user_id}</p></td></tr></table><table><tr><td><p><strong>2</strong></p></td><td><p><strong>Backend creates Razorpay Order</strong></p><p>razorpay.orders.create({amount: 9900, currency: 'INR', receipt: 'order_user123_ts'})</p></td></tr></table><table><tr><td><p><strong>3</strong></p></td><td><p><strong>Backend returns order_id to TMA</strong></p><p>TMA receives: {order_id, amount, currency, key_id}</p></td></tr></table><table><tr><td><p><strong>4</strong></p></td><td><p><strong>TMA opens Razorpay checkout</strong></p><p>Uses Razorpay.js with order_id â€” opens native payment sheet</p></td></tr></table><table><tr><td><p><strong>5</strong></p></td><td><p><strong>User completes payment (UPI/card)</strong></p><p>Razorpay processes payment â€” returns payment_id to TMA</p></td></tr></table><table><tr><td><p><strong>6</strong></p></td><td><p><strong>TMA sends payment_id to backend</strong></p><p>POST /api/verify-payment with {payment_id, order_id, signature}</p></td></tr></table><table><tr><td><p><strong>7</strong></p></td><td><p><strong>Backend verifies Razorpay signature</strong></p><p>CRITICAL â€” never skip. See signature verification below.</p></td></tr></table><table><tr><td><p><strong>8</strong></p></td><td><p><strong>On valid signature: activate premium in Supabase</strong></p><p>UPDATE users SET plan='ind_monthly', premium_until=NOW()+30d</p></td></tr></table><table><tr><td><p><strong>9</strong></p></td><td><p><strong>Backend confirms to TMA + bot sends message</strong></p><p>TMA shows success. Bot: 'ğŸ‰ Premium activated!'</p></td></tr></table><h2><strong>2.4 Signature Verification â€” CRITICAL SECURITY STEP</strong></h2><p>Never activate premium based only on the payment_id. Always verify the Razorpay signature first. This prevents fraudulent activation.</p><table><tr><td><p>import hmac, hashlib</p><p>def verify_razorpay_signature(order_id, payment_id, signature, secret):</p><p>    message = f'{order_id}|{payment_id}'</p><p>    expected = hmac.new(</p><p>        secret.encode('utf-8'),</p><p>        message.encode('utf-8'),</p><p>        hashlib.sha256</p><p>    ).hexdigest()</p><p>    return hmac.compare_digest(expected, signature)</p><p># Usage in your route handler:</p><p>is_valid = verify_razorpay_signature(</p><p>    order_id=data['razorpay_order_id'],</p><p>    payment_id=data['razorpay_payment_id'],</p><p>    signature=data['razorpay_signature'],</p><p>    secret=os.environ['RAZORPAY_KEY_SECRET']</p><p>)</p><p>if not is_valid:</p><p>    return {'error': 'Invalid signature'}, 400</p></td></tr></table><h2><strong>2.5 Webhook Handler â€” Server-Side Events</strong></h2><p>Razorpay also sends webhook events to your server independently of the frontend flow. This is the more reliable way to track payments â€” the webhook fires even if the user closes the app.</p><table><tr><td><p># Webhook signature verification (different from payment signature)</p><p>import hmac, hashlib</p><p>def verify_webhook_signature(payload_body, signature, webhook_secret):</p><p>    expected = hmac.new(</p><p>        webhook_secret.encode('utf-8'),</p><p>        payload_body,  # raw bytes, not decoded</p><p>        hashlib.sha256</p><p>    ).hexdigest()</p><p>    return hmac.compare_digest(expected, signature)</p><p># In your /webhooks/razorpay route:</p><p>sig = request.headers.get('X-Razorpay-Signature')</p><p>if not verify_webhook_signature(request.data, sig, WEBHOOK_SECRET):</p><p>    return 'Unauthorized', 401</p></td></tr></table><table><thead><tr><th><p><strong>Webhook Event</strong></p></th><th><p><strong>What It Means</strong></p></th><th><p><strong>Action Required</strong></p></th></tr></thead><tbody><tr><td><p>payment.captured</p></td><td><p>Payment succeeded</p></td><td><p>Activate premium. Log to payments table.</p></td></tr><tr><td><p>payment.failed</p></td><td><p>Payment failed</p></td><td><p>Send user friendly message. Do not activate.</p></td></tr><tr><td><p>refund.created</p></td><td><p>Refund issued</p></td><td><p>Deactivate premium if refund covers full amount.</p></td></tr></tbody></table><table><tr><td><p><strong>ğŸ”’ Idempotency Rule</strong></p><p>Webhooks can be delivered more than once. Always check if you have already processed a</p><p>payment_id before acting on it. Store processed payment_ids in your DB and skip duplicates.</p><p>Pattern: Before activating premium, check: SELECT * FROM payments WHERE payment_id = ? LIMIT 1</p><p>If a row exists â†’ skip. If not â†’ process and insert row.</p></td></tr></table><h1><strong>3. Telegram Stars Integration</strong></h1><p>Telegram Stars is the in-app currency for Telegram. Users can buy Stars with real money and spend them inside bots. For Nah That's Fake, Stars are our secondary payment option â€” ideal for international users who want to pay without leaving Telegram.</p><h2><strong>3.1 How Stars Work</strong></h2><ul><li>Stars are purchased by users directly from Telegram (not from you).</li><li>When a user pays with Stars, Telegram deducts from their balance and sends your bot a payment confirmation.</li><li>Telegram takes a 30% fee. You receive 70% of the Stars value as withdrawable TON crypto (converted).</li><li>Stars payments are non-refundable by default â€” this simplifies your refund handling significantly.</li><li>There is NO Razorpay-style checkout â€” the entire payment UI is native Telegram. You just trigger it with an invoice.</li></ul><h2><strong>3.2 Stars Payment Flow</strong></h2><table><tr><td><p><strong>1</strong></p></td><td><p><strong>User taps [Pay with Telegram Stars] in TMA or bot</strong></p><p>TMA calls backend or bot sends invoice directly</p></td></tr></table><table><tr><td><p><strong>2</strong></p></td><td><p><strong>Bot sends invoice message via Telegram API</strong></p><p>sendInvoice() with currency='XTR', prices=[{label:'Premium',amount:250}]</p></td></tr></table><table><tr><td><p><strong>3</strong></p></td><td><p><strong>Telegram shows native Stars payment dialog to user</strong></p><p>User sees their Stars balance and confirms</p></td></tr></table><table><tr><td><p><strong>4</strong></p></td><td><p><strong>User confirms payment â€” Telegram fires pre_checkout_query</strong></p><p>Your bot MUST answer within 10 seconds or payment fails</p></td></tr></table><table><tr><td><p><strong>5</strong></p></td><td><p><strong>Bot answers pre_checkout_query: OK</strong></p><p>answerPreCheckoutQuery(ok=True) â€” validates the order</p></td></tr></table><table><tr><td><p><strong>6</strong></p></td><td><p><strong>Telegram fires successful_payment update to your bot</strong></p><p>Contains payload with plan_id and user_id</p></td></tr></table><table><tr><td><p><strong>7</strong></p></td><td><p><strong>Backend receives successful_payment â€” activates premium</strong></p><p>Update Supabase. Bot confirms to user.</p></td></tr></table><h2><strong>3.3 Stars Code Reference</strong></h2><table><tr><td><p># Step 2: Send invoice from bot</p><p>await bot.send_invoice(</p><p>    chat_id=user_id,</p><p>    title='Nah That's Fake Premium â€” 1 Month',</p><p>    description='Unlimited checks, PDF export, full reports.',</p><p>    payload=f'ind_monthly:{user_id}',   # Your custom payload â€” returned on success</p><p>    currency='XTR',                      # XTR = Telegram Stars</p><p>    prices=[LabeledPrice('Premium Monthly', 250)],  # 250 Stars</p><p>)</p><p># Step 4: Handle pre_checkout_query</p><p>@dp.pre_checkout_query()</p><p>async def pre_checkout(query: PreCheckoutQuery):</p><p>    # Validate the payload if needed</p><p>    await query.answer(ok=True)</p><p># Step 6: Handle successful_payment</p><p>@dp.message(F.successful_payment)</p><p>async def payment_received(message: Message):</p><p>    payload = message.successful_payment.invoice_payload</p><p>    plan_id, user_id = payload.split(':')</p><p>    await activate_premium(user_id, plan_id)</p><p>    await message.answer('ğŸ‰ Premium activated! You now have unlimited checks.')</p></td></tr></table><table><tr><td><p><strong>âš ï¸ Stars Withdrawal Note</strong></p><p>Stars earnings are withdrawable as TON cryptocurrency via Fragment (fragment.com).</p><p>Minimum withdrawal threshold applies. For MVP, simply accumulate Stars â€” you can</p><p>withdraw in batches once you hit the minimum. This requires a TON wallet.</p><p>Razorpay (INR) and Stars (TON) are completely separate revenue streams.</p></td></tr></table><h1><strong>4. Subscription Lifecycle</strong></h1><p>Since we are using one-time payments for MVP (not recurring subscriptions), the lifecycle is simpler than a full subscription service. Here is how premium status is managed end-to-end.</p><h2><strong>4.1 Premium Status Fields in Database</strong></h2><p>These fields must exist on the users table in Supabase. See Document 10 (Database Schema) for full schema.</p><table><thead><tr><th><p><strong>Field</strong></p></th><th><p><strong>Type</strong></p></th><th><p><strong>Description</strong></p></th></tr></thead><tbody><tr><td><p>plan</p></td><td><p>text</p></td><td><p>free | ind_monthly | ind_annual | grp_monthly</p></td></tr><tr><td><p>premium_until</p></td><td><p>timestamptz</p></td><td><p>NULL for free. Expiry datetime for premium users.</p></td></tr><tr><td><p>group_id</p></td><td><p>text</p></td><td><p>NULL for individual. Telegram group ID for group plans.</p></td></tr><tr><td><p>payment_method</p></td><td><p>text</p></td><td><p>razorpay | stars | NULL</p></td></tr><tr><td><p>last_payment_id</p></td><td><p>text</p></td><td><p>Most recent Razorpay payment_id or Stars charge_id</p></td></tr><tr><td><p>last_paid_at</p></td><td><p>timestamptz</p></td><td><p>Timestamp of last successful payment</p></td></tr><tr><td><p>grace_until</p></td><td><p>timestamptz</p></td><td><p>3-day grace period after expiry before downgrade</p></td></tr></tbody></table><h2><strong>4.2 Premium Check Logic</strong></h2><p>Every time a user tries to perform a check, this logic runs. It must be fast â€” use a cached result where possible.</p><table><tr><td><p>def get_user_check_allowance(user_id: str) -&gt; dict:</p><p>    user = db.get_user(user_id)</p><p>    now = datetime.utcnow()</p><p>    # 1. Check if premium is active (including grace period)</p><p>    is_premium = (</p><p>        user.premium_until is not None and</p><p>        user.premium_until &gt; now  # premium_until includes grace_until</p><p>    )</p><p>    if is_premium:</p><p>        return {'allowed': True, 'unlimited': True, 'reason': 'premium'}</p><p>    # 2. Check permanent credits</p><p>    if user.permanent_credits &gt; 0:</p><p>        return {'allowed': True, 'unlimited': False, 'source': 'credits'}</p><p>    # 3. Check daily free allocation</p><p>    checks_today = db.count_checks_today(user_id)  # checks since midnight IST</p><p>    if checks_today &lt; 3:</p><p>        return {'allowed': True, 'unlimited': False, 'source': 'daily'}</p><p>    # 4. No allowance remaining</p><p>    return {'allowed': False, 'reason': 'limit_reached'}</p></td></tr></table><h2><strong>4.3 Expiry &amp; Grace Period</strong></h2><table><tr><td><p><strong>Day 0</strong></p></td><td><p><strong>User pays for 30-day plan</strong></p><p>premium_until = NOW() + 30 days. grace_until = premium_until + 3 days.</p></td></tr></table><table><tr><td><p><strong>Day 30</strong></p></td><td><p><strong>Plan expires</strong></p><p>premium_until reached. Bot does NOT downgrade yet â€” grace period starts.</p></td></tr></table><table><tr><td><p><strong>Day 30â€“33</strong></p></td><td><p><strong>Grace period active</strong></p><p>User still has premium access. Bot sends reminder: 'Your premium expires in X days. Renew to keep access!'</p></td></tr></table><table><tr><td><p><strong>Day 31</strong></p></td><td><p><strong>Renewal reminder (Day 1 of grace)</strong></p><p>'â° Your Nah That's Fake Premium expires tomorrow. Renew now to keep unlimited checks.'</p></td></tr></table><table><tr><td><p><strong>Day 32</strong></p></td><td><p><strong>Renewal reminder (Day 2 of grace)</strong></p><p>'â° Last day of grace period! Renew premium to avoid losing access.'</p></td></tr></table><table><tr><td><p><strong>Day 33</strong></p></td><td><p><strong>Grace period ends â€” downgrade</strong></p><p>plan set to 'free'. premium_until and grace_until set to NULL. Bot: 'Your premium has expired. Renew anytime!'</p></td></tr></table><h2><strong>4.4 Renewal Reminder Messages â€” Exact Copy</strong></h2><table><tr><td><p><strong>ğŸ“… Renewal Reminder â€” Day 1 of Grace Period</strong></p><p>â° Heads up! Your Nah That's Fake Premium expires in 2 days.</p><p>You've had unlimited checks, full reports, and PDF exports.</p><p>Don't lose it â€” renew now and keep your streak going.</p><p>[ğŸ”„ Renew Premium â†’]</p></td></tr></table><table><tr><td><p><strong>ğŸ“… Renewal Reminder â€” Final Day of Grace Period</strong></p><p>ğŸš¨ Today's your last day of premium access.</p><p>After midnight, you'll go back to 3 checks/day.</p><p>Renew in the next few hours to stay unlimited.</p><p>[ğŸ”„ Renew Now â€” â‚¹99/month â†’]</p></td></tr></table><table><tr><td><p><strong>ğŸ“… Post-Expiry Message (on next interaction)</strong></p><p>ğŸ˜¢ Your Premium has expired.</p><p>You're back on the free plan â€” 3 checks per day.</p><p>Your referral credits are still safe and never expire.</p><p>Ready to go unlimited again?</p><p>[â­ Renew Premium â†’]    [ğŸ¤ Refer for free credits â†’]</p></td></tr></table><h1><strong>5. Failed Payments &amp; Refund Policy</strong></h1><h2><strong>5.1 Failed Payment Handling</strong></h2><p>Failed payments must be handled gracefully. The user should never be left confused about what happened.</p><table><thead><tr><th><p><strong>Failure Reason</strong></p></th><th><p><strong>Razorpay Error Code</strong></p></th><th><p><strong>User-Facing Message</strong></p></th></tr></thead><tbody><tr><td><p>Insufficient funds</p></td><td><p>BAD_REQUEST_ERROR</p></td><td><p>Payment failed â€” looks like your account didn't have enough funds. Try a different payment method.</p></td></tr><tr><td><p>Bank declined</p></td><td><p>GATEWAY_ERROR</p></td><td><p>Your bank declined the payment. Try again or use a different card/UPI.</p></td></tr><tr><td><p>UPI timeout</p></td><td><p>GATEWAY_ERROR</p></td><td><p>UPI request timed out. No money was deducted. Try again.</p></td></tr><tr><td><p>Network error</p></td><td><p>SERVER_ERROR</p></td><td><p>Something went wrong on our end. No payment was taken. Please try again in a minute.</p></td></tr><tr><td><p>User cancelled</p></td><td><p>BAD_REQUEST_ERROR</p></td><td><p>Payment cancelled. Your plan hasn't changed. Come back anytime!</p></td></tr><tr><td><p>International card blocked</p></td><td><p>BAD_REQUEST_ERROR</p></td><td><p>This card doesn't support international payments. Try UPI or a domestic card.</p></td></tr></tbody></table><table><tr><td><p><strong>ğŸ” Retry Logic for Failed Payments</strong></p><p>â€¢ Do NOT automatically retry failed payments â€” this can lead to double charges and chargebacks.</p><p>â€¢ Instead: show the user a friendly message with a [Try Again] button that generates a new order.</p><p>â€¢ Each payment attempt creates a new Razorpay order_id â€” never reuse a failed order.</p><p>â€¢ Log all failed attempts to your payments table with status='failed' for analytics.</p></td></tr></table><h2><strong>5.2 Refund Policy</strong></h2><p>Our refund policy must be defined clearly before launch â€” both for your Terms of Service and for how your backend handles refunds.</p><table><tr><td><p><strong>ğŸ’¸ Refund Policy (For Terms of Service)</strong></p><p>Individual Premium (Razorpay):</p><p>  â€¢ Refund available within 48 hours of purchase if fewer than 5 checks have been performed.</p><p>  â€¢ No refund after 48 hours or after 5+ checks â€” the service has been used.</p><p>  â€¢ Annual plans: pro-rated refund for unused months, only within first 7 days.</p><p>Group Premium (Razorpay):</p><p>  â€¢ Refund available within 24 hours of first activation.</p><p>  â€¢ No refund once auto-scan mode has been enabled (service has been actively used).</p><p>Telegram Stars:</p><p>  â€¢ No refunds â€” Stars payments are final per Telegram's policy.</p><p>  â€¢ Display this clearly before Stars payment is initiated.</p></td></tr></table><h2><strong>5.3 How to Issue a Razorpay Refund</strong></h2><table><tr><td><p>import razorpay</p><p>client = razorpay.Client(auth=(KEY_ID, KEY_SECRET))</p><p># Full refund</p><p>refund = client.payment.refund(payment_id, {</p><p>    'amount': 9900,   # Amount in paise (â‚¹99 = 9900 paise)</p><p>    'speed': 'normal',  # 'normal' (5-7 days) or 'optimum' (instant, higher cost)</p><p>    'notes': {'reason': 'User requested within 48hr window'}</p><p>})</p><p># After issuing refund: deactivate premium in Supabase</p><p>db.update_user(user_id, {'plan': 'free', 'premium_until': None})</p><p># Send confirmation to user via bot</p></td></tr></table><h2><strong>5.4 Chargeback Protection</strong></h2><p>Chargebacks occur when a user disputes a payment with their bank. Here is how to protect yourself:</p><ul><li>Log every payment with: user_id, telegram_username, payment_id, amount, timestamp, IP, checks performed after payment.</li><li>If a chargeback is initiated: Razorpay will email you. Respond within their deadline with the payment log as evidence.</li><li>Your strongest defence: the user performed N checks after payment (proves the service was used).</li><li>Flag any user who initiates a chargeback: block their account from future purchases until resolved.</li></ul><h1><strong>6. Revenue Tracking &amp; Reconciliation</strong></h1><p>Even at MVP scale, you need to know where money is coming from. This section defines what to track and where.</p><h2><strong>6.1 Payments Table (Summary)</strong></h2><p>Every payment â€” successful or failed â€” must be logged. Full schema is in Document 10, but the critical fields are:</p><table><thead><tr><th><p><strong>Field</strong></p></th><th><p><strong>Type</strong></p></th><th><p><strong>Example</strong></p></th></tr></thead><tbody><tr><td><p>id</p></td><td><p>uuid</p></td><td><p>auto-generated</p></td></tr><tr><td><p>user_id</p></td><td><p>text</p></td><td><p>123456789 (Telegram user ID)</p></td></tr><tr><td><p>plan_id</p></td><td><p>text</p></td><td><p>ind_monthly</p></td></tr><tr><td><p>amount_inr</p></td><td><p>integer</p></td><td><p>9900 (in paise) or 0 for Stars</p></td></tr><tr><td><p>amount_stars</p></td><td><p>integer</p></td><td><p>250 or 0 for INR</p></td></tr><tr><td><p>payment_method</p></td><td><p>text</p></td><td><p>razorpay | stars</p></td></tr><tr><td><p>payment_id</p></td><td><p>text</p></td><td><p>pay_Razorpay123 or tg_stars_456</p></td></tr><tr><td><p>status</p></td><td><p>text</p></td><td><p>success | failed | refunded</p></td></tr><tr><td><p>created_at</p></td><td><p>timestamptz</p></td><td><p>2026-02-14 15:42:00+05:30</p></td></tr><tr><td><p>premium_until</p></td><td><p>timestamptz</p></td><td><p>2026-03-14 15:42:00+05:30</p></td></tr><tr><td><p>checks_used</p></td><td><p>integer</p></td><td><p>Checks used DURING this premium period</p></td></tr></tbody></table><h2><strong>6.2 Revenue Dashboard (Simple Queries)</strong></h2><p>These are the SQL queries you will run in Supabase to monitor revenue. Copy them into a Supabase dashboard view.</p><table><tr><td><p>-- Total revenue this month (INR)</p><p>SELECT SUM(amount_inr) / 100.0 as revenue_inr</p><p>FROM payments</p><p>WHERE status = 'success'</p><p>  AND payment_method = 'razorpay'</p><p>  AND created_at &gt;= date_trunc('month', NOW());</p><p>-- Active premium users right now</p><p>SELECT COUNT(*) as active_premium</p><p>FROM users</p><p>WHERE plan != 'free'</p><p>  AND premium_until &gt; NOW();</p><p>-- Revenue by plan type this month</p><p>SELECT plan_id, COUNT(*) as count, SUM(amount_inr)/100.0 as total_inr</p><p>FROM payments</p><p>WHERE status = 'success' AND created_at &gt;= date_trunc('month', NOW())</p><p>GROUP BY plan_id;</p><p>-- Churn: users who did NOT renew after expiry</p><p>SELECT COUNT(*) as churned</p><p>FROM users</p><p>WHERE plan = 'free'</p><p>  AND last_paid_at IS NOT NULL</p><p>  AND last_paid_at &lt; NOW() - INTERVAL '30 days';</p></td></tr></table><h2><strong>6.3 Tax &amp; Compliance Notes (India)</strong></h2><table><tr><td><p><strong>ğŸ‡®ğŸ‡³ India-Specific Compliance</strong></p><p>GST: If annual revenue exceeds â‚¹20 lakh (â‚¹10 lakh for some states), GST registration is required.</p><p>     Current GST rate on software/SaaS: 18%. Factor this into pricing.</p><p>     For MVP: operate below threshold to defer GST complexity. Track revenue carefully.</p><p>TDS: If you pay any contractor &gt; â‚¹30,000, you may need to deduct TDS. Not relevant initially.</p><p>Razorpay: Issues a settlement report + GST invoice for their fees. Download monthly for records.</p><p>Stars/TON: Crypto income must be declared under Schedule VDA in ITR. Consult a CA before withdrawal.</p><p>Disclaimer: This is informational only â€” consult a Chartered Accountant for your specific situation.</p></td></tr></table><h1><strong>7. Testing Your Payment Integration</strong></h1><p>Never test with real money during development. Both Razorpay and Telegram Stars have test modes.</p><h2><strong>7.1 Razorpay Test Mode</strong></h2><table><thead><tr><th><p><strong>Test Scenario</strong></p></th><th><p><strong>Test Card / UPI</strong></p></th><th><p><strong>Expected Result</strong></p></th></tr></thead><tbody><tr><td><p>Successful payment</p></td><td><p>4111 1111 1111 1111 (Visa)</p></td><td><p>Payment captured, premium activated</p></td></tr><tr><td><p>Failed â€” declined</p></td><td><p>4000 0000 0000 0002</p></td><td><p>Payment fails, no premium</p></td></tr><tr><td><p>Failed â€” insufficient</p></td><td><p>5105 1051 0510 5100</p></td><td><p>Payment fails with BAD_REQUEST</p></td></tr><tr><td><p>UPI success</p></td><td><p>success@razorpay</p></td><td><p>UPI payment succeeds</p></td></tr><tr><td><p>UPI failure</p></td><td><p>failure@razorpay</p></td><td><p>UPI payment fails</p></td></tr><tr><td><p>Webhook delivery</p></td><td><p>Use Razorpay webhook tester</p></td><td><p>Simulate all webhook events</p></td></tr></tbody></table><h2><strong>7.2 Telegram Stars Test Mode</strong></h2><table><tr><td><p># In test mode, send invoice with provider_token=''</p><p># and use currency='XTR'</p><p># Telegram will show a test payment dialog</p><p># To test Stars in development:</p><p># 1. Use a test bot token (from @BotFather with /newbot)</p><p># 2. Stars payments work in test bots natively</p><p># 3. No real Stars are deducted in test mode</p><p># Important: Stars invoices do NOT need provider_token</p><p># Leave provider_token='' or omit it entirely for Stars</p></td></tr></table><h2><strong>7.3 Pre-Launch Payment Checklist</strong></h2><ul><li>Test successful Razorpay payment (card) â†’ premium activates âœ“</li><li>Test successful Razorpay payment (UPI) â†’ premium activates âœ“</li><li>Test failed payment â†’ no premium, friendly error message âœ“</li><li>Test webhook delivery â†’ payment.captured activates premium independently âœ“</li><li>Test duplicate webhook â†’ second event is ignored (idempotency) âœ“</li><li>Test Stars payment â†’ premium activates via successful_payment âœ“</li><li>Test expiry + grace period â†’ user downgraded after grace_until âœ“</li><li>Test renewal reminder messages â†’ sent on correct days âœ“</li><li>Test refund flow â†’ premium deactivated after refund âœ“</li><li>Test signature verification bypass â†’ correctly rejected âœ“</li></ul><table><tr><td><p><strong>ğŸ“Œ Document Status</strong></p><p>Document 3 of 13 â€” COMPLETE</p><p>Next: Document 4 â€” Terms of Service, Privacy Policy &amp; Disclaimer</p><p>Your AI IDE should reference this document when building:</p><p>  â€¢ /api/create-order endpoint</p><p>  â€¢ /api/verify-payment endpoint</p><p>  â€¢ /webhooks/razorpay endpoint</p><p>  â€¢ Bot Stars invoice handler</p><p>  â€¢ pre_checkout_query handler</p><p>  â€¢ successful_payment handler</p><p>  â€¢ Premium activation/deactivation logic</p><p>  â€¢ Grace period and expiry scheduler (cron job)</p></td></tr></table>